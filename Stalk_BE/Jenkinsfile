pipeline {
  agent any

  environment {
    DOCKER_IMAGE = "stalk-be:latest"
  }

  stages {
    stage('Docker Build & Run') {
      steps {
        // Secret file ë¡œë“œ + ì‹¤ì œ resources í´ë”ì— ë³µì‚¬
        withCredentials([file(credentialsId: 'APP_CONFIG_FILE', variable: 'APP_PROPS_FILE')]) {
          dir('Stalk_BE') {
            sh '''
              echo "ğŸ“¦ application.properties ë³µì‚¬ ì¤‘..."
              cp $APP_PROPS_FILE src/main/resources/application.properties

              echo "ğŸ› ï¸ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬..."
              docker stop stalk-be || true
              docker rm stalk-be || true

              echo "ğŸ³ ë„ì»¤ ë¹Œë“œ ì‹œì‘..."
              docker build -t $DOCKER_IMAGE .

              echo "ğŸš€ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì¤‘..."
              docker run -d \
                --add-host=host.docker.internal:host-gateway \
                -p 8081:8081 \
                --name stalk-be $DOCKER_IMAGE
            '''
          }
        }
      }
    }
  }
}
