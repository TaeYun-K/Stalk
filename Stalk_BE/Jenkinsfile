pipeline {
  agent any

  environment {
    BRANCH_NAME = "${env.GIT_BRANCH}".replaceAll(".*/", "")
  }

  stages {
    stage('Deploy BE') {
      steps {
        script {
          // ë³€ê²½ëœ íŒŒì¼ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
          def changed = sh(script: "git diff --name-only HEAD~1 HEAD", returnStdout: true).trim()

          // Stalk_BE ë””ë ‰í† ë¦¬ë§Œ ê°ì§€
          if (!changed.contains("Stalk_BE/")) {
            echo "ğŸŸ¡ BE ë””ë ‰í† ë¦¬ ë³€ê²½ ì—†ìŒ â†’ ë°°í¬ ìƒëµ"
            return
          }

          def isProd = BRANCH_NAME == 'master'
          def COMPOSE_FILE = isProd ? 'docker-compose.prod.yml' : 'docker-compose.dev.yml'
          def CREDENTIAL_ID = isProd ? 'properties-prod' : 'properties-dev'
          def CONTAINER    = isProd ? 'stalk-be-prod'            : 'stalk-be-dev'

          withCredentials([file(credentialsId: CREDENTIAL_ID, variable: 'APP_PROPS_FILE')]) {
            dir('Stalk_BE') {
              sh """
                echo "ğŸ“¦ application.properties ë³µì‚¬ ì¤‘..."
                rm -f application.properties
                cp -f "$APP_PROPS_FILE" application.properties
              """
            }

            sh """
                # í”„ë¡œì íŠ¸ ì´ë¦„ì„ ë¬¶ì–´ë‘ë©´ workspaceê°€ ë°”ë€Œì–´ë„ ê°™ì€ ê·¸ë£¹ìœ¼ë¡œ ì¸ì‹
                export COMPOSE_PROJECT_NAME=stalk-be-dev

                echo "ğŸ”´ ê¸°ì¡´ BE ìŠ¤íƒ ì •ë¦¬(down + remove-orphans)â€¦"
                docker compose -f ${COMPOSE_FILE} down --remove-orphans

                echo "ğŸš€ BE ì¬ë°°í¬(up + build + force-recreate)â€¦"
                docker compose -f ${COMPOSE_FILE} up -d --build --force-recreate stalk-be
            """
          }
        }
      }
    }
  }
}
