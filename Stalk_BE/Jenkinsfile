pipeline {
  agent any

  environment {
    BRANCH_NAME = "${env.GIT_BRANCH}".replaceAll(".*/", "")
  }

  stages {
    stage('Deploy BE') {
      steps {
        script {
          // ë³€ê²½ëœ íŒŒì¼ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
          def changed = sh(script: "git diff --name-only HEAD~1 HEAD", returnStdout: true).trim()

          // Stalk_BE ë””ë ‰í† ë¦¬ë§Œ ê°ì§€
          if (!changed.contains("Stalk_BE/")) {
            echo "ğŸŸ¡ BE ë””ë ‰í† ë¦¬ ë³€ê²½ ì—†ìŒ â†’ ë°°í¬ ìƒëµ"
          }

          else {
            def isProd = BRANCH_NAME == 'master'
            def COMPOSE_FILE = isProd ? 'docker-compose.prod.yml' : 'docker-compose.dev.yml'
            def CREDENTIAL_ID = isProd ? 'properties-prod' : 'properties-dev'
            def CONTAINER    = isProd ? 'stalk-be-prod'            : 'stalk-be-dev'

            withCredentials([file(credentialsId: CREDENTIAL_ID, variable: 'APP_PROPS_FILE')]) {
              dir('Stalk_BE') {
                sh """
                  echo "ğŸ“¦ application.properties ë³µì‚¬ ì¤‘..."
                  rm -f application.properties
                  cp -f "$APP_PROPS_FILE" application.properties
                """
              }

              sh """
                echo "ğŸ—‘ï¸ ê¸°ì¡´ BE ì»¨í…Œì´ë„ˆ ì§ì ‘ ì‚­ì œ (${CONTAINER})..."
                docker rm -f ${CONTAINER} || true

                echo "ğŸš€ ë„ì»¤ ì»´í¬ì¦ˆë¡œ ë¹Œë“œ ë° ì‹¤í–‰..."
                docker compose -f ${COMPOSE_FILE} up -d --build stalk-be
              """
            }
          }
        }
      }
    }
    // //nginx ì»¨í…Œì´ë„ˆ ìˆ˜ì •ì´ í•„ìš”í•  ë•Œë§Œ ì‚¬ìš© 
    // stage('Deploy nginx') {   
    //   steps {
    //     script {
    //       def isProd = BRANCH_NAME == 'master'
    //       def COMPOSE_FILE = isProd ? 'docker-compose.prod.yml' : 'docker-compose.dev.yml'
    //       def CONTAINER    = isProd ? 'nginx-prod'              : 'nginx-dev'

    //       sh """
    //         echo "ğŸ—‘ï¸ ê¸°ì¡´ nginx ì»¨í…Œì´ë„ˆ ì§ì ‘ ì‚­ì œ (${CONTAINER})..."
    //         docker rm -f ${CONTAINER} || true

    //         echo "ğŸ›¡ï¸ nginx docker-compose ì‹¤í–‰ ì¤‘ (${COMPOSE_FILE})..."
    //         docker compose -f ${COMPOSE_FILE} up -d --no-deps nginx
    //       """
    //     }
    //   }
    // }
  }
}
