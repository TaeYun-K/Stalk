<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>í† ìŠ¤í˜ì´ë¨¼ì¸  ê²°ì œ í…ŒìŠ¤íŠ¸</title>
  <script src="https://js.tosspayments.com/v1/payment"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 600px;
      margin: 50px auto;
      padding: 20px;
      background-color: #f5f5f5;
    }

    .container {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    h1 {
      color: #1e3a8a;
      text-align: center;
      margin-bottom: 30px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #374151;
    }

    input, select, textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #3b82f6;
    }

    .btn {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, #3b82f6, #1d4ed8);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }

    .btn:disabled {
      background: #9ca3af;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .info-box {
      background: #eff6ff;
      border: 1px solid #bfdbfe;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
    }

    .loading {
      display: none;
      text-align: center;
      color: #6b7280;
    }

    .error {
      background: #fee2e2;
      border: 1px solid #fecaca;
      color: #dc2626;
      padding: 10px;
      border-radius: 8px;
      margin-top: 10px;
      display: none;
    }

    .success {
      background: #d1fae5;
      border: 1px solid #a7f3d0;
      color: #059669;
      padding: 10px;
      border-radius: 8px;
      margin-top: 10px;
      display: none;
    }
  </style>
</head>
<body>
<div class="container">
  <h1>ğŸ¥ ì–´ë“œë°”ì´ì € ìƒë‹´ ì˜ˆì•½ ê²°ì œ</h1>

  <div class="info-box">
    <strong>ğŸ’¡ í…ŒìŠ¤íŠ¸ ì •ë³´</strong><br>
    â€¢ ìƒë‹´ë£Œ: 30,000ì›<br>
    â€¢ ê²°ì œìˆ˜ë‹¨: ì¹´ë“œ, ê°„í¸ê²°ì œ, ê³„ì¢Œì´ì²´<br>
    â€¢ í…ŒìŠ¤íŠ¸ í™˜ê²½ì—ì„œ ì‹¤ì œ ê²°ì œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤
  </div>

  <form id="paymentForm">
    <div class="form-group">
      <label for="advisorId">ì–´ë“œë°”ì´ì € ì„ íƒ</label>
      <select id="advisorId" name="advisorId" required>
        <option value="">ì–´ë“œë°”ì´ì €ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</option>
        <option value="1">ì´ìˆ˜ì§„ ì „ë¬¸ê°€ (ì¤‘ì¥ê¸° íˆ¬ì)</option>
        <option value="2">ë°•ë¯¼ìˆ˜ ì „ë¬¸ê°€ (ë‹¨ê¸° ë§¤ë§¤)</option>
        <option value="3">ê¹€ì˜í¬ ì „ë¬¸ê°€ (í¬íŠ¸í´ë¦¬ì˜¤ ê´€ë¦¬)</option>
      </select>
    </div>

    <div class="form-group">
      <label for="consultationDate">ìƒë‹´ ë‚ ì§œ</label>
      <input type="date" id="consultationDate" name="consultationDate" required min="">
    </div>

    <div class="form-group">
      <label for="consultationTime">ìƒë‹´ ì‹œê°„</label>
      <select id="consultationTime" name="consultationTime" required>
        <option value="">ì‹œê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”</option>
        <option value="09:00">09:00</option>
        <option value="10:00">10:00</option>
        <option value="11:00">11:00</option>
        <option value="14:00">14:00</option>
        <option value="15:00">15:00</option>
        <option value="16:00">16:00</option>
        <option value="17:00">17:00</option>
      </select>
    </div>

    <div class="form-group">
      <label for="requestMessage">ìƒë‹´ ìš”ì²­ ë©”ì‹œì§€</label>
      <textarea id="requestMessage" name="requestMessage" rows="3"
                placeholder="ìƒë‹´ë°›ê³  ì‹¶ì€ ë‚´ìš©ì„ ê°„ë‹¨íˆ ì ì–´ì£¼ì„¸ìš”"></textarea>
    </div>

    <button type="button" class="btn" onclick="testConnection()"
            style="background: #10b981; margin-bottom: 10px;">
      ğŸ”Œ ì„œë²„ ì—°ê²° í…ŒìŠ¤íŠ¸
    </button>

    <button type="submit" class="btn" id="paymentBtn">
      ğŸ’³ 30,000ì› ê²°ì œí•˜ê³  ì˜ˆì•½í•˜ê¸°
    </button>

    <div class="loading" id="loading">
      â³ ê²°ì œ ì¤€ë¹„ ì¤‘...
    </div>

    <div class="error" id="errorMsg"></div>
    <div class="success" id="successMsg"></div>
  </form>
</div>

<script>
  // ì˜¤ëŠ˜ ë‚ ì§œë¥¼ ìµœì†Œê°’ìœ¼ë¡œ ì„¤ì •
  document.getElementById('consultationDate').min = new Date().toISOString().split('T')[0];

  // ë°±ì—”ë“œ API ê¸°ë³¸ URL (í˜„ì¬ ì ‘ì† ì¤‘ì¸ í¬íŠ¸ì™€ ë™ì¼í•˜ê²Œ ì„¤ì •)
  const API_BASE_URL = `${window.location.protocol}//${window.location.host}/api/v1`;

  // í† ìŠ¤í˜ì´ë¨¼ì¸  í´ë¼ì´ì–¸íŠ¸ í‚¤ (ë°±ì—”ë“œì—ì„œ ë°›ì•„ì˜¬ ì˜ˆì •)
  let tossPayments;

  // ì—°ê²° í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ ì¶”ê°€
  async function testConnection() {
    try {
      const response = await fetch(`${API_BASE_URL}/payments/test`);
      const data = await response.json();
      console.log('ì—°ê²° í…ŒìŠ¤íŠ¸ ê²°ê³¼:', data);
      showSuccess('âœ… ì„œë²„ ì—°ê²° ì„±ê³µ!');
    } catch (error) {
      console.error('ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:', error);
      showError('âŒ ì„œë²„ ì—°ê²° ì‹¤íŒ¨: ' + error.message);
    }
  }

  // í¼ ì œì¶œ ì´ë²¤íŠ¸
  document.getElementById('paymentForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const formData = new FormData(e.target);
    const paymentData = {
      advisorId: parseInt(formData.get('advisorId')),
      consultationDate: formData.get('consultationDate'),
      consultationTime: formData.get('consultationTime'),
      requestMessage: formData.get('requestMessage') || ''
    };

    if (!validateForm(paymentData)) {
      return;
    }

    await processPayment(paymentData);
  });

  // í¼ ìœ íš¨ì„± ê²€ì¦
  function validateForm(data) {
    if (!data.advisorId) {
      showError('ì–´ë“œë°”ì´ì €ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
      return false;
    }
    if (!data.consultationDate) {
      showError('ìƒë‹´ ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
      return false;
    }
    if (!data.consultationTime) {
      showError('ìƒë‹´ ì‹œê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
      return false;
    }

    // ê³¼ê±° ë‚ ì§œ ì²´í¬
    const selectedDate = new Date(data.consultationDate);
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    if (selectedDate < today) {
      showError('ê³¼ê±° ë‚ ì§œëŠ” ì„ íƒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      return false;
    }

    return true;
  }

  // ê²°ì œ ì²˜ë¦¬
  async function processPayment(paymentData) {
    try {
      showLoading(true);
      hideMessages();

      // 1. ë°±ì—”ë“œì—ì„œ ê²°ì œ ì¤€ë¹„ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
      const prepareResponse = await fetch(`${API_BASE_URL}/payments/prepare`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
          // Authorization í—¤ë” ì œê±° (ì¸ì¦ ì—†ì´ í—ˆìš©ë˜ë„ë¡ ì„¤ì •í–ˆìœ¼ë¯€ë¡œ)
        },
        body: JSON.stringify(paymentData)
      });

      if (!prepareResponse.ok) {
        const errorData = await prepareResponse.json();
        throw new Error(errorData.message || 'ê²°ì œ ì¤€ë¹„ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }

      const prepareData = await prepareResponse.json();
      const paymentInfo = prepareData.result;

      console.log('ê²°ì œ ì¤€ë¹„ ì™„ë£Œ:', paymentInfo);

      // 2. í† ìŠ¤í˜ì´ë¨¼ì¸  ê°ì²´ ì´ˆê¸°í™”
      tossPayments = TossPayments(paymentInfo.clientKey);

      // 3. ê²°ì œì°½ í˜¸ì¶œ
      await tossPayments.requestPayment('ì¹´ë“œ', {
        amount: paymentInfo.amount,
        orderId: paymentInfo.orderId,
        orderName: paymentInfo.orderName,
        customerName: paymentInfo.customerName,
        customerEmail: paymentInfo.customerEmail,
        successUrl: paymentInfo.successUrl,
        failUrl: paymentInfo.failUrl,
      });

    } catch (error) {
      console.error('ê²°ì œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:', error);
      showError(error.message || 'ê²°ì œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    } finally {
      showLoading(false);
    }
  }

  // ë¡œë”© ìƒíƒœ í‘œì‹œ
  function showLoading(show) {
    const loading = document.getElementById('loading');
    const btn = document.getElementById('paymentBtn');

    if (show) {
      loading.style.display = 'block';
      btn.disabled = true;
      btn.textContent = 'ê²°ì œ ì¤€ë¹„ ì¤‘...';
    } else {
      loading.style.display = 'none';
      btn.disabled = false;
      btn.textContent = 'ğŸ’³ 30,000ì› ê²°ì œí•˜ê³  ì˜ˆì•½í•˜ê¸°';
    }
  }

  // ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
  function showError(message) {
    const errorDiv = document.getElementById('errorMsg');
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';

    // 3ì´ˆ í›„ ìë™ ìˆ¨ê¹€
    setTimeout(() => {
      errorDiv.style.display = 'none';
    }, 5000);
  }

  // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
  function showSuccess(message) {
    const successDiv = document.getElementById('successMsg');
    successDiv.textContent = message;
    successDiv.style.display = 'block';
  }

  // ë©”ì‹œì§€ ìˆ¨ê¹€
  function hideMessages() {
    document.getElementById('errorMsg').style.display = 'none';
    document.getElementById('successMsg').style.display = 'none';
  }

  // URL íŒŒë¼ë¯¸í„°ì—ì„œ ê²°ê³¼ ì²˜ë¦¬ (ì„±ê³µ/ì‹¤íŒ¨ í˜ì´ì§€ì—ì„œ ë¦¬ë‹¤ì´ë ‰íŠ¸ëœ ê²½ìš°)
  window.addEventListener('load', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const orderId = urlParams.get('orderId');
    const paymentKey = urlParams.get('paymentKey');
    const code = urlParams.get('code');
    const message = urlParams.get('message');

    if (orderId && paymentKey) {
      // ê²°ì œ ì„±ê³µ
      showSuccess(`âœ… ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ì£¼ë¬¸ë²ˆí˜¸: ${orderId}`);
    } else if (code && message) {
      // ê²°ì œ ì‹¤íŒ¨
      showError(`âŒ ê²°ì œ ì‹¤íŒ¨: ${message} (ì½”ë“œ: ${code})`);
    }
  });
</script>
</body>
</html>