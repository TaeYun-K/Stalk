<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.Stalk.project.community.dao.CommunityMapper">

  <!-- 커뮤니티 글 목록 조회 -->
  <insert id="createCommunityPost">
    INSERT INTO community_posts (user_id,
                                 category,
                                 title,
                                 content,
                                 view_count,
                                 comment_count,
                                 created_at,
                                 updated_at)
    VALUES (#{userId},
            #{request.category},
            #{request.title},
            #{request.content},
            0,
            0,
            NOW(),
            NOW())
  </insert>

  <!-- 사용자 이름 조회 (권한 체크용) -->
  <select id="findUserNameById" resultType="String">
    SELECT CASE
             WHEN role = 'ADVISOR' THEN name
             ELSE nickname
             END as userName
    FROM users
    WHERE id = #{userId}
  </select>

  <!-- 커뮤니티 글 작성 -->
  <select id="findCommunityPosts"
    resultType="com.Stalk.project.community.dto.out.CommunityPostSummaryDto">
    SELECT
    cp.id as postId,
    cp.title,
    CASE
    WHEN u.role = 'ADVISOR' THEN u.name
    ELSE u.nickname
    END as authorName,
    u.role as authorRole,
    cp.category,
    cp.view_count as viewCount,
    cp.comment_count as commentCount,
    cp.created_at as createdAt
    FROM community_posts cp
    INNER JOIN users u ON cp.user_id = u.id
    <where>
      <if test="category != null and category != ''">
        AND cp.category = #{category}
      </if>
    </where>
    ORDER BY cp.created_at DESC
    LIMIT #{pageRequest.limitPlusOne} OFFSET #{pageRequest.offset}
  </select>

  <!-- 마지막으로 생성된 글 ID 조회 -->
  <select id="getLastInsertedPostId" resultType="Long">
    SELECT LAST_INSERT_ID()
  </select>

</mapper>