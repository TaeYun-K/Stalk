<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.Stalk.project.favorite.dao.FavoriteMapper">

    <!-- 사용자가 찜한 전문가 목록 조회 -->
    <select id="findFavoriteAdvisorsByUserId"
            resultType="com.Stalk.project.favorite.dto.out.FavoriteAdvisorResponseDto">
        SELECT
            a.advisor_id as advisorId,
            u.name as name,
            u.image as profileImage,
            adi.avg_rating as averageRating,
            adi.review_counting as reviewCount,
            adi.preferred_trade_style as preferredTradeStyle,
            adi.short_intro as shortIntro
        FROM user_favorite_advisors ufa
                 INNER JOIN advisor a ON ufa.advisor_id = a.advisor_id
                 INNER JOIN users u ON a.advisor_id = u.id
                 LEFT JOIN advisor_detail_info adi ON a.advisor_id = adi.advisor_id
        WHERE ufa.user_id = #{userId}
          AND a.is_approved = 1
        ORDER BY ufa.created_at DESC
            LIMIT #{pageRequest.limitPlusOne} OFFSET #{pageRequest.offset}
    </select>

    <!-- 전문가 존재 및 승인 여부 확인 -->
    <select id="isAdvisorExistsAndApproved" resultType="boolean">
        SELECT COUNT(*) > 0
        FROM advisor
        WHERE advisor_id = #{advisorId}
          AND is_approved = 1
    </select>

    <!-- 찜 존재 여부 확인 -->
    <select id="isFavoriteExists" resultType="boolean">
        SELECT COUNT(*) > 0
        FROM user_favorite_advisors
        WHERE user_id = #{userId}
          AND advisor_id = #{advisorId}
    </select>

    <!-- 찜 추가 -->
    <insert id="insertFavorite">
        INSERT INTO user_favorite_advisors (user_id, advisor_id, created_at)
        VALUES (#{userId}, #{advisorId}, CURRENT_TIMESTAMP)
    </insert>

    <!-- 찜 삭제 -->
    <delete id="deleteFavorite">
        DELETE FROM user_favorite_advisors
        WHERE user_id = #{userId}
          AND advisor_id = #{advisorId}
    </delete>

</mapper>
