<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.Stalk.project.global.notification.dao.NotificationMapper">

  <!-- 알람 생성 -->
  <insert id="createNotification" parameterType="com.Stalk.project.global.notification.dto.in.NotificationCreateDto">
    INSERT INTO notifications (
      user_id, type, title, message, related_id, is_read, created_at
    ) VALUES (
               #{userId}, #{type}, #{title}, #{message}, #{relatedId}, 0, NOW()
             )
  </insert>

  <!-- 사용자별 알람 목록 조회 (페이징) -->
  <select id="findNotificationsByUserId" resultType="com.Stalk.project.global.notification.dto.out.NotificationResponseDto">
    SELECT
      id as notificationId,
      type,
      title,
      message,
      related_id as relatedId,
      is_read as isRead,
      created_at as createdAt
    FROM notifications
    WHERE user_id = #{userId}
    ORDER BY created_at DESC
      LIMIT #{pageRequest.limitPlusOne} OFFSET #{pageRequest.offset}
  </select>

  <!-- 알람 읽음 처리 -->
  <update id="markAsRead">
    UPDATE notifications
    SET is_read = 1
    WHERE id = #{notificationId} AND user_id = #{userId} AND is_read = 0
  </update>

  <!-- 읽지않은 알람 개수 조회 -->
  <select id="countUnreadNotifications" resultType="java.lang.Integer">
    SELECT COUNT(*)
    FROM notifications
    WHERE user_id = #{userId} AND is_read = 0
  </select>

  <!-- 특정 시간 이후의 새로운 알람 조회 -->
  <select id="findNewNotifications" resultType="com.Stalk.project.global.notification.dto.out.NotificationResponseDto">
    SELECT
      id as notificationId,
      type,
      title,
      message,
      related_id as relatedId,
      is_read as isRead,
      created_at as createdAt
    FROM notifications
    WHERE user_id = #{userId}
      AND UNIX_TIMESTAMP(created_at) * 1000 > #{afterTimestamp}
    ORDER BY created_at DESC
      LIMIT 10
  </select>

  <!-- 알람 존재 여부 및 소유자 확인 -->
  <select id="existsByIdAndUserId" resultType="java.lang.Boolean">
    SELECT COUNT(*) > 0
    FROM notifications
    WHERE id = #{notificationId} AND user_id = #{userId}
  </select>

  <!-- 사용자의 모든 알람을 읽음 처리 -->
  <update id="markAllAsRead">
    UPDATE notifications
    SET is_read = 1
    WHERE user_id = #{userId} AND is_read = 0
  </update>

  <!-- 오래된 알람 삭제 (30일 이상) -->
  <delete id="deleteOldNotifications">
    DELETE FROM notifications
    WHERE created_at <![CDATA[<]]> DATE_SUB(NOW(), INTERVAL #{daysBefore} DAY)
  </delete>

</mapper>