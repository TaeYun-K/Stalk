<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.Stalk.project.api.review.dao.ReviewMapper">

  <!-- 상담 정보 조회 (리뷰 작성 가능 여부 확인용) -->
  <select id="findConsultationForReview" resultType="com.Stalk.project.api.review.dao.ReviewMapper$ConsultationForReviewDto">
    SELECT
      cs.id,
      cs.user_id as userId,
      cs.advisor_id as advisorId,
      cs.status,
      au.name as advisorName,
      cu.name as userName
    FROM consultation_sessions cs
           INNER JOIN users au ON cs.advisor_id = au.id
           INNER JOIN users cu ON cs.user_id = cu.id
    WHERE cs.id = #{consultationId}
  </select>

  <!-- 기존 리뷰 존재 여부 확인 -->
  <select id="existsReviewByConsultationId" resultType="boolean">
    SELECT COUNT(*) > 0
    FROM advisor_reviews
    WHERE user_id = (SELECT user_id FROM consultation_sessions WHERE id = #{consultationId})
      AND advisor_id = (SELECT advisor_id FROM consultation_sessions WHERE id = #{consultationId})
      AND is_deleted = 0
  </select>

  <!-- 리뷰 작성 -->
  <insert id="insertReview">
    INSERT INTO advisor_reviews (user_id, advisor_id, rating, content, created_at, is_deleted)
    VALUES (#{userId}, #{advisorId}, #{rating}, #{content}, NOW(), 0)
  </insert>

  <!-- 마지막 삽입된 리뷰 ID 조회 -->
  <select id="getLastInsertId" resultType="Long">
    SELECT LAST_INSERT_ID()
  </select>

  <!-- 리뷰 상세 조회 (수정/삭제 권한 확인용) -->
  <select id="findReviewForUpdate" resultType="com.Stalk.project.api.review.dao.ReviewMapper$ReviewDetailForUpdateDto">
    SELECT
      id,
      user_id as userId,
      advisor_id as advisorId,
      rating,
      content,
      DATE_FORMAT(created_at, '%Y-%m-%dT%H:%i:%s+09:00') as createdAt
    FROM advisor_reviews
    WHERE id = #{reviewId} AND is_deleted = 0
  </select>

  <!-- 리뷰 수정 -->
  <update id="updateReview">
    UPDATE advisor_reviews
    SET rating = #{rating},
        content = #{content}
    WHERE id = #{reviewId}
  </update>

  <!-- 리뷰 삭제 (소프트 삭제) -->
  <update id="deleteReview">
    UPDATE advisor_reviews
    SET is_deleted = 1
    WHERE id = #{reviewId}
  </update>

  <!-- 내가 작성한 리뷰 목록 조회 -->
  <select id="findMyReviews" resultType="com.Stalk.project.api.review.dto.out.ReviewResponseDto">
    SELECT
      ar.id as reviewId,
      cs.id as consultationId,
      u.name as advisorName,
      ar.rating,
      ar.content,
      DATE_FORMAT(ar.created_at, '%Y-%m-%dT%H:%i:%s+09:00') as createdAt
    FROM advisor_reviews ar
           INNER JOIN consultation_sessions cs ON ar.user_id = cs.user_id AND ar.advisor_id = cs.advisor_id
           INNER JOIN users u ON ar.advisor_id = u.id
    WHERE ar.user_id = #{userId}
      AND ar.is_deleted = 0
    ORDER BY ar.created_at DESC
      LIMIT #{pageRequest.limitPlusOne} OFFSET #{pageRequest.offset}
  </select>

  <!-- 특정 전문가의 리뷰 목록 조회 -->
  <select id="findAdvisorReviews" resultType="com.Stalk.project.api.review.dto.out.AdvisorReviewResponseDto">
    SELECT
      ar.id as reviewId,
      u.name as userName,
      ar.rating,
      ar.content,
      DATE_FORMAT(ar.created_at, '%Y-%m-%dT%H:%i:%s+09:00') as createdAt
    FROM advisor_reviews ar
           INNER JOIN users u ON ar.user_id = u.id
    WHERE ar.advisor_id = #{advisorId}
      AND ar.is_deleted = 0
    ORDER BY ar.created_at DESC
      LIMIT #{pageRequest.limitPlusOne} OFFSET #{pageRequest.offset}
  </select>

</mapper>