<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.Stalk.project.api.advisor.profile.dao.AdvisorProfileMapper">

  <!-- ===== 권한 및 상태 확인 ===== -->

  <!-- 전문가 승인 여부 확인 -->
  <select id="isApprovedAdvisor" resultType="Boolean">
    SELECT is_approved
    FROM advisor
    WHERE advisor_id = #{advisorId}
  </select>

  <!-- 전문가의 상세 정보 존재 여부 확인 -->
  <select id="hasAdvisorDetailInfo" resultType="Boolean">
    SELECT COUNT(*) > 0
    FROM advisor_detail_info
    WHERE advisor_id = #{advisorId}
  </select>

  <!-- ===== 프로필 관리 ===== -->

  <!-- 전문가 상세 정보 등록 -->
  <insert id="insertAdvisorDetailInfo">
    <!-- advisor_detail_info 테이블에 상세 정보 삽입 -->
    INSERT INTO advisor_detail_info (
    advisor_id,
    profile_image_url,
    public_contact,
    short_intro,
    long_intro,
    preferred_trade_style,
    created_at,
    updated_at
    ) VALUES (
    #{advisorId},
    #{request.profileImageUrl},
    #{request.publicContact},
    #{request.shortIntro},
    #{request.longIntro},
    #{request.preferredTradeStyle},
    NOW(),
    NOW()
    );

    <!-- advisor 테이블에 상담료 업데이트 및 프로필 완성 상태 변경 -->
    UPDATE advisor
    SET consultation_fee = #{request.consultationFee},
    is_profile_completed = 1,
    updated_at = NOW()
    WHERE advisor_id = #{advisorId};
  </insert>

  <!-- 전문가 상세 정보 수정 -->
  <update id="updateAdvisorDetailInfo">
    <!-- advisor_detail_info 테이블 업데이트 -->
    UPDATE advisor_detail_info
    SET updated_at = NOW()
    <if test="request.profileImageUrl != null">
      , profile_image_url = #{request.profileImageUrl}
    </if>
    <if test="request.publicContact != null">
      , public_contact = #{request.publicContact}
    </if>
    <if test="request.shortIntro != null">
      , short_intro = #{request.shortIntro}
    </if>
    <if test="request.longIntro != null">
      , long_intro = #{request.longIntro}
    </if>
    <if test="request.preferredTradeStyle != null">
      , preferred_trade_style = #{request.preferredTradeStyle}
    </if>
    WHERE advisor_id = #{advisorId};

    <!-- advisor 테이블의 상담료 업데이트 (필요한 경우) -->
    <if test="request.consultationFee != null">
      UPDATE advisor
      SET consultation_fee = #{request.consultationFee},
      updated_at = NOW()
      WHERE advisor_id = #{advisorId};
    </if>
  </update>

  <!-- ===== 경력 정보 관리 ===== -->

  <!-- 경력 정보 등록 -->
  <insert id="insertCareerEntry">
    INSERT INTO advisor_career_entries (
      advisor_id,
      title,
      description,
      started_at,
      ended_at,
      created_at
    ) VALUES (
               #{advisorId},
               #{career.title},
               #{career.description},
               #{career.startedAt},
               #{career.endedAt},
               NOW()
             )
  </insert>

  <!-- 경력 정보 수정 -->
  <update id="updateCareerEntry">
    UPDATE advisor_career_entries
    SET
      title = #{career.title},
      description = #{career.description},
      started_at = #{career.startedAt},
      ended_at = #{career.endedAt}
    WHERE id = #{career.id}
      AND advisor_id = #{advisorId}
  </update>

  <!-- 경력 정보 삭제 -->
  <delete id="deleteCareerEntry">
    DELETE FROM advisor_career_entries
    WHERE id = #{careerId}
      AND advisor_id = #{advisorId}
  </delete>

  <!-- 특정 전문가의 경력 정보 개수 조회 -->
  <select id="countCareerEntries" resultType="int">
    SELECT COUNT(*)
    FROM advisor_career_entries
    WHERE advisor_id = #{advisorId}
  </select>

  <!-- 경력 정보 소유권 확인 -->
  <select id="isCareerEntryOwner" resultType="Boolean">
    SELECT COUNT(*) > 0
    FROM advisor_career_entries
    WHERE advisor_id = #{advisorId}
      AND id = #{careerId}
  </select>

  <!-- ===== 자격증 승인 요청 ===== -->

  <!-- 자격증 승인 요청 등록 -->
  <insert id="insertApprovalRequest">
    INSERT INTO advisor_approval_logs (
      advisor_id,
      admin_id,
      email,
      contact,
      certificate_file_sn,
      birth,
      certificate_file_number,
      status,
      requested_at,
      created_at
    )
    SELECT
      #{advisorId},
      NULL,  -- admin_id는 승인 시에 설정
      u.email,
      u.contact,
      #{request.certificateFileSn},
      #{request.birth},
      #{request.certificateFileNumber},
      'PENDING',
      NOW(),
      NOW()
    FROM users u
    WHERE u.id = #{advisorId}
  </insert>

  <!-- 생성된 승인 요청 ID 조회 -->
  <select id="getLastInsertedApprovalRequestId" resultType="Long">
    SELECT LAST_INSERT_ID()
  </select>

  <!-- 이전 요청 존재 및 소유권 확인 -->
  <select id="isPreviousRequestValid" resultType="Boolean">
    SELECT COUNT(*) > 0
    FROM advisor_approval_logs
    WHERE id = #{previousRequestId}
      AND advisor_id = #{advisorId}
  </select>

  <!-- ===== 승인 이력 조회 ===== -->

  <!-- 전문가의 승인 요청 이력 조회 (페이지네이션) -->
  <select id="findApprovalHistory" resultType="java.util.LinkedHashMap">
    SELECT
      aal.id as requestId,
      -- 자격증명은 advisor 테이블의 certificate_name을 사용 (회원가입시 입력한 자격증명)
      a.certificate_name as certificateName,
      aal.certificate_file_sn as certificateFileSn,
      aal.certificate_file_number as certificateFileNumber,
      aal.status,
      aal.requested_at as requestedAt,
      aal.processed_at as processedAt,
      aal.reason as rejectionReason,
      au.name as processedByAdminName
    FROM advisor_approval_logs aal
           INNER JOIN advisor a ON aal.advisor_id = a.advisor_id
           LEFT JOIN users au ON aal.admin_id = au.id
    WHERE aal.advisor_id = #{advisorId}
    ORDER BY aal.created_at DESC
      LIMIT #{pageRequest.limitPlusOne} OFFSET #{pageRequest.offset}
  </select>

</mapper>