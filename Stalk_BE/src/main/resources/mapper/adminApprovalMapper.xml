<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.Stalk.project.api.admin.dao.AdminApprovalMapper">

    <!-- AdvisorApprovalRequestDto ResultMap 정의 -->
    <resultMap id="AdvisorApprovalRequestResultMap" type="com.Stalk.project.api.admin.dto.in.AdvisorApprovalRequestDto">
        <!-- 기본 필드들 -->
        <result property="requestId" column="requestId"/>
        <result property="advisorId" column="advisorId"/>
        <result property="status" column="status"/>
        <result property="requestedAt" column="requestedAt"/>
        <result property="processedAt" column="processedAt"/>
        <result property="advisorName" column="advisorName"/>
        <result property="email" column="email"/>
        <result property="contact" column="contact"/>
        <result property="rejectionReason" column="rejectionReason"/>

        <!-- 중첩 객체: 자격증 정보 -->
        <association property="certificateInfo" javaType="com.Stalk.project.api.admin.dto.in.AdvisorApprovalRequestDto$CertificateInfoDto">
            <result property="certificateName" column="certificate_name"/>
            <result property="certificateNumber" column="certificate_number"/>
            <result property="serialNumber" column="certificate_serial"/>
        </association>

        <!-- 중첩 객체: 관리자 정보 -->
        <association property="processedBy" javaType="com.Stalk.project.api.admin.dto.in.AdvisorApprovalRequestDto$AdminInfoDto">
            <result property="adminId" column="admin_id"/>
            <result property="adminName" column="admin_name"/>
        </association>
    </resultMap>

    <!-- 전문가 인증 요청 목록 조회 -->
    <select id="findApprovalRequests" resultMap="AdvisorApprovalRequestResultMap">
        SELECT
        aal.id as requestId,
        aal.advisor_id as advisorId,
        aal.status,
        DATE_FORMAT(aal.requested_at, '%Y-%m-%dT%H:%i:%s+09:00') as requestedAt,
        DATE_FORMAT(aal.processed_at, '%Y-%m-%dT%H:%i:%s+09:00') as processedAt,

        <!-- 전문가 기본 정보 -->
        u.name as advisorName,
        aal.email,
        aal.contact,

        <!-- 자격증 정보 (개별 컬럼으로) -->
        aal.certificate_file_sn as certificate_name,
        aal.certificate_file_number as certificate_number,
        aal.certificate_file_sn as certificate_serial,

        <!-- 처리한 관리자 정보 -->
        admin_u.id as admin_id,
        admin_u.name as admin_name,

        <!-- 거절 관련 정보 -->
        aal.reason as rejectionReason

        FROM advisor_approval_logs aal
        INNER JOIN users u ON aal.advisor_id = u.id
        LEFT JOIN users admin_u ON aal.admin_id = admin_u.id

        <where>
            <if test="status != null and status.name() != 'ALL'">
                AND aal.status = #{status}
            </if>
        </where>

        ORDER BY aal.requested_at DESC
        LIMIT #{pageRequest.limitPlusOne} OFFSET #{pageRequest.offset}
    </select>

    <!-- 특정 인증 요청 조회 -->
    <select id="findApprovalRequestById" resultMap="AdvisorApprovalRequestResultMap">
        SELECT
        aal.id as requestId,
        aal.advisor_id as advisorId,
        aal.status,
        DATE_FORMAT(aal.requested_at, '%Y-%m-%dT%H:%i:%s+09:00') as requestedAt,
        DATE_FORMAT(aal.processed_at, '%Y-%m-%dT%H:%i:%s+09:00') as processedAt,

        <!-- 전문가 기본 정보 -->
        u.name as advisorName,
        aal.email,
        aal.contact,

        <!-- 자격증 정보 (개별 컬럼으로) -->
        aal.certificate_file_sn as certificate_name,
        aal.certificate_file_number as certificate_number,
        aal.certificate_file_sn as certificate_serial,

        <!-- 처리한 관리자 정보 -->
        admin_u.id as admin_id,
        admin_u.name as admin_name,

        <!-- 거절 관련 정보 -->
        aal.reason as rejectionReason

        FROM advisor_approval_logs aal
        INNER JOIN users u ON aal.advisor_id = u.id
        LEFT JOIN users admin_u ON aal.admin_id = admin_u.id
        WHERE aal.id = #{requestId}
    </select>

    <!-- 인증 요청 승인 처리 -->
    <update id="approveRequest">
        UPDATE advisor_approval_logs
        SET
            status = 'APPROVED',
            admin_id = #{adminId},
            processed_at = NOW()
        WHERE id = #{requestId}
          AND status = 'PENDING'
    </update>

    <!-- 기존 자격증 존재 여부 확인 -->
    <select id="countExistingCertificate" resultType="int">
        SELECT COUNT(*)
        FROM advisor_certificates
        WHERE advisor_id = #{advisorId}
          AND certificate_file_sn = #{certificateFileSn}
          AND birth = #{birth}
          AND certificate_file_number = #{certificateFileNumber}
    </select>

    <!-- 기존의 XML을 이렇게 수정 -->
    <insert id="insertCertificateIfNotExists">
        INSERT INTO advisor_certificates (
        advisor_id,
        certificate_file_sn,
        birth,
        certificate_file_number,
        certificate_name,
        issued_by,
        issued_at,
        expires_at,
        certificate_url,
        created_at
        )
        SELECT
        aal.advisor_id,
        aal.certificate_file_sn,
        aal.birth,
        aal.certificate_file_number,
        COALESCE(aal.certificate_name, '미확인 자격증') as certificate_name,
        NULL,
        NULL,
        NULL,
        NULL,
        NOW()
        FROM advisor_approval_logs aal
        WHERE aal.id = #{approvalRequest.requestId}  <!-- 이렇게 변경 -->
        AND aal.status = 'APPROVED'
        AND aal.certificate_file_sn IS NOT NULL
        AND aal.birth IS NOT NULL
        AND aal.certificate_file_number IS NOT NULL
        AND NOT EXISTS (
        SELECT 1
        FROM advisor_certificates ac
        WHERE ac.advisor_id = aal.advisor_id
        AND ac.certificate_file_sn = aal.certificate_file_sn
        AND ac.certificate_file_number = aal.certificate_file_number
        );
    </insert>

    <!-- advisor 테이블의 is_approved 업데이트 -->
    <update id="updateAdvisorApprovalStatus">
        UPDATE advisor
        SET
            is_approved = 1,
            approved_at = NOW()
        WHERE advisor_id = #{advisorId}
    </update>

    <!-- 인증 요청 거절 처리 -->
    <update id="rejectRequest">
        UPDATE advisor_approval_logs
        SET
        status = 'REJECTED',
        admin_id = #{adminId},
        processed_at = NOW(),
        reason = #{rejectionReason}
        <if test="customReason != null and customReason != ''">
            , reason = CONCAT(#{rejectionReason}, ': ', #{customReason})
        </if>
        WHERE id = #{requestId}
        AND status = 'PENDING'
    </update>

    <!-- 알림 생성 -->
    <insert id="createNotification">
        INSERT INTO notifications (
            user_id, type, title, message, related_id, is_read, created_at
        ) VALUES (
                     #{userId}, #{type}, #{title}, #{message}, #{relatedId}, 0, NOW()
                 )
    </insert>

</mapper>