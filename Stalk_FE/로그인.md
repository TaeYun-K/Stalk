# 로그인 기능 구현 문서 (2024년 7월 29일 업데이트)

## 📋 개요
Docker 서버와 연동된 로그인 기능을 프론트엔드에 구현했습니다. 토큰은 메모리에 저장되며, 프록시를 통해 CORS 문제를 해결했습니다.

## 🚀 주요 변경사항 (최신)

### 1. Docker 서버 연동
- **API 서버**: `https://i13e205.p.ssafy.io:8443`
- **프록시 설정**: Vite 프록시로 CORS 문제 해결
- **포트**: 3001 (프론트엔드)

### 2. 토큰 저장 방식 변경
- **기존**: 쿠키 저장
- **현재**: 메모리 변수 저장 (`accessToken`, `refreshToken`, `userInfo`)
- **장점**: 보안 강화, 브라우저 새로고침 시 로그아웃

## 🔧 수정된 파일들

### 1. 핵심 설정 파일
- `vite.config.ts` - 프록시 설정 및 포트 3001
- `package.json` - Docker 서버 연결용 스크립트 추가

### 2. 서비스 파일들
- `src/services/authService.ts` - 메모리 토큰 저장, Docker API 연동
- `src/services/userService.ts` - API_BASE_URL 추가
- `src/services/consultationService.ts` - API_BASE_URL 추가
- `src/services/watchlistService.ts` - API_BASE_URL 추가

### 3. 컴포넌트 파일들
- `src/components/homepage-navbar.tsx` - Docker API URL 사용
- `src/context/AuthContext.tsx` - 메모리 토큰 관리
- `src/components/ProtectedRoute.tsx` - 인증 보호
- `src/components/AdminProtectedRoute.tsx` - 관리자 보호

## 🏗️ 구현 내용

### 1. Vite 프록시 설정 (`vite.config.ts`)
```typescript
server: {
  port: 3001,
  open: true,
  host: true,
  proxy: {
    '/api': {
      target: 'https://i13e205.p.ssafy.io:8443',
      changeOrigin: true,
      secure: false
    }
  }
}
```

### 2. 메모리 토큰 관리 (`src/services/authService.ts`)
```typescript
// 메모리에 토큰 저장을 위한 변수들
let accessToken: string | null = null;
let refreshToken: string | null = null;
let userInfo: any = null;

const API_BASE_URL = import.meta.env.VITE_API_URL || '/api';
```

### 3. 로그인 플로우
```typescript
// 1. 사용자 입력
const loginData = { userId: 'user001', password: 'password123' };

// 2. API 호출 (프록시 통해)
const response = await fetch(`${API_BASE_URL}/auth/login`, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify(loginData)
});

// 3. 메모리에 토큰 저장
accessToken = result.result.accessToken;
refreshToken = result.result.refreshToken;
userInfo = { userId, userName, role };
```

### 4. 로그아웃 플로우
```typescript
// 1. 서버에 로그아웃 요청
await fetch(`${API_BASE_URL}/auth/logout`, {
  method: 'POST',
  headers: { 'Authorization': `Bearer ${accessToken}` }
});

// 2. 메모리에서 토큰 제거
accessToken = null;
refreshToken = null;
userInfo = null;
```

## 🔐 인증 시스템

### 1. 토큰 관리
- **Access Token**: 메모리 변수에 저장
- **Refresh Token**: 메모리 변수에 저장
- **사용자 정보**: 메모리 변수에 저장
- **자동 갱신**: 토큰 만료 시 자동 갱신

### 2. 보안 특징
- **브라우저 새로고침 시**: 로그아웃 상태 (토큰 초기화)
- **메모리 기반**: 쿠키보다 보안성 향상
- **프록시 사용**: CORS 문제 해결

### 3. 역할 기반 접근 제어
- **USER**: 일반 사용자
- **ADVISOR**: 전문가
- **ADMIN**: 관리자

## 🧪 테스트 계정

### 일반 사용자 (USER)
- `user001` / `password123` - 김철수
- `user002` / `password123` - 이영희

### 전문가 (ADVISOR)
- `advisor001` / `password123` - 한승우 (승인됨)
- `advisor002` / `password123` - 이수진 (승인됨)
- `advisor003` / `password123` - 박미승 (승인안됨)

### 관리자 (ADMIN)
- `admin001` / `password123` - 관리자

## 🔧 환경 설정

### 1. 개발 환경 실행
```bash
cd Stalk_FE
npm run dev
```

### 2. Docker 서버 연결
```bash
# 기본 (Docker 서버 연결)
npm run dev

# 명시적으로 Docker 서버 연결
npm run dev:docker

# 로컬 서버 연결 (필요시)
npm run dev:local
```

### 3. API 엔드포인트
- **프론트엔드**: `http://localhost:3001`
- **백엔드**: `https://i13e205.p.ssafy.io:8443`
- **프록시**: `/api` → Docker 서버로 전달

## 📝 사용법

### 1. 기본 실행
```bash
cd Stalk_FE
npm run dev
```

### 2. 로그인 테스트
1. 브라우저에서 `http://localhost:3001` 접속
2. 로그인 페이지에서 테스트 계정 사용
3. 역할에 따라 다른 페이지로 리다이렉트

### 3. 관리자 테스트
1. `admin001` / `password123`로 로그인
2. 자동으로 `/admin` 페이지로 이동
3. 관리자 전용 기능 확인

## ⚠️ 주의사항

### 1. 토큰 저장 방식
- **메모리 저장**: 브라우저 새로고침 시 로그아웃
- **세션 기반**: 탭을 닫으면 로그아웃
- **보안 강화**: 쿠키보다 안전

### 2. CORS 처리
- **프록시 사용**: Vite 프록시로 CORS 문제 해결
- **API URL**: `/api`로 통일
- **백엔드 설정**: Docker 서버에서 CORS 설정 필요

### 3. 에러 처리
- **네트워크 에러**: Mock fallback으로 처리
- **토큰 만료**: 자동 갱신 시도
- **권한 없음**: 적절한 페이지로 리다이렉트

## 🚀 향후 개선사항

### 완료된 항목
- ✅ Docker 서버 연동
- ✅ 메모리 토큰 저장
- ✅ 프록시 CORS 해결
- ✅ 역할 기반 접근 제어
- ✅ 자동 토큰 갱신
- ✅ 관리자 페이지 보호

### 예정된 항목
- 소셜 로그인 연동
- 비밀번호 재설정 기능
- 토큰 만료 알림
- 세션 지속성 개선

## 🔧 최근 수정사항 (2024.07.29)

1. **Docker 서버 연결**: `https://i13e205.p.ssafy.io:8443`로 API 서버 변경
2. **토큰 저장 방식**: 쿠키 → 메모리 변수로 변경
3. **프록시 설정**: Vite 프록시로 CORS 문제 해결
4. **포트 변경**: 3000 → 3001로 변경
5. **모든 API 통일**: `/api` 경로로 통일
6. **보안 강화**: 메모리 기반 토큰 저장으로 보안성 향상

## 📊 현재 상태

- **프론트엔드**: `http://localhost:3001` ✅
- **백엔드**: `https://i13e205.p.ssafy.io:8443` ✅
- **프록시**: CORS 문제 해결 ✅
- **토큰**: 메모리 저장 ✅
- **로그인**: 정상 작동 ✅
- **역할별 접근**: 정상 작동 ✅ 