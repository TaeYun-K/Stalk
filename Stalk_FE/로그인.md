# 로그인 기능 구현 문서

## 📋 개요
백엔드 API와 연동된 로그인 기능을 프론트엔드에 구현했습니다. 관리자 역할별 리다이렉트 기능이 추가되었습니다.

## 🔧 수정된 파일들

### 1. 새로 생성된 파일
- `src/utils/cookieUtils.ts` - 쿠키 관리 유틸리티
- `src/context/AuthContext.tsx` - 인증 상태 관리 Context
- `src/components/ProtectedRoute.tsx` - 인증이 필요한 페이지 보호
- `src/components/AdminProtectedRoute.tsx` - 관리자 전용 페이지 보호

### 2. 수정된 파일들
- `src/types/index.ts` - 백엔드 API 응답 타입 추가
- `src/services/authService.ts` - 실제 API 호출로 변경 (Mock 대체 로직 포함)
- `src/pages/login-page.tsx` - 로그인 로직 구현 (역할별 리다이렉트)
- `src/components/navbar.tsx` - 로그아웃 API 연동
- `src/components/homepage-navbar.tsx` - AuthContext 연동
- `src/components/new-navbar.tsx` - AuthContext 연동
- `src/App.tsx` - 인증 상태 기반 라우팅 개선 (관리자 페이지 보호)

## 🏗️ 구현 내용

### 1. 쿠키 관리 유틸리티 (`src/utils/cookieUtils.ts`)
```typescript
// 쿠키 설정 (보안 강화)
setCookie(name: string, value: string, days: number = 7)

// 쿠키 가져오기
getCookie(name: string): string | null

// 쿠키 삭제
removeCookie(name: string)
```

### 2. 타입 정의 (`src/types/index.ts`)
```typescript
// 백엔드 API 요청/응답 타입
interface LoginRequest {
  userId: string;
  password: string;
}

interface LoginResponse {
  accessToken: string;
  refreshToken: string;
  userId: number;
  userName: string;
  role: 'USER' | 'ADVISOR' | 'ADMIN';
  message: string;
}

interface UserInfo {
  userId: number;
  userName: string;
  role: 'USER' | 'ADVISOR' | 'ADMIN';
}

interface BaseApiResponse<T> {
  httpStatus: string;
  isSuccess: boolean;
  message: string;
  code: number;
  result: T;
}
```

### 3. 인증 서비스 (`src/services/authService.ts`)
```typescript
// 로그인 (Mock fallback 포함)
static async login(data: LoginRequest): Promise<LoginResponse>

// 로그아웃 (CORS 에러 처리 포함)
static async logout(): Promise<void>

// 토큰 갱신 (네트워크 에러 처리)
static async refreshToken(): Promise<string | null>

// 토큰 가져오기
static getAccessToken(): string | null

// 인증된 API 요청 헬퍼 (토큰 갱신 포함)
static async authenticatedRequest(url: string, options: RequestInit)

// 자동 로그인 체크
static checkAutoLogin(): boolean

// 사용자 정보 가져오기
static getUserInfo(): UserInfo | null
```

### 4. 로그인 페이지 (`src/pages/login-page.tsx`)
- 실제 API 호출로 변경
- **역할별 리다이렉트**: 관리자는 `/admin`, 일반 사용자는 `/`
- 로딩 상태 및 에러 처리 추가
- 폼 필드명 수정 (`id` → `userId`)
- AuthContext와 연동하여 자동 로그인 지원

### 5. 인증 Context (`src/context/AuthContext.tsx`)
- 전역 인증 상태 관리
- 자동 로그인 기능
- 토큰 갱신 자동 처리
- 로딩 상태 관리 (`isLoading`, `isLoggingIn`, `isLoggingOut`)

### 6. Navbar 컴포넌트들
- **`src/components/navbar.tsx`**: AuthContext와 연동, 사용자 정보 표시, 로그아웃 API 연동
- **`src/components/homepage-navbar.tsx`**: AuthContext 연동으로 통일
- **`src/components/new-navbar.tsx`**: AuthContext 연동으로 통일

### 7. 보호 라우트 컴포넌트들
- **`src/components/ProtectedRoute.tsx`**: 인증이 필요한 페이지 보호
- **`src/components/AdminProtectedRoute.tsx`**: 관리자 전용 페이지 보호

### 8. App.tsx 라우팅 (`src/App.tsx`)
- 인증 상태 기반 라우팅 개선
- **관리자 페이지 보호**: `/admin` 경로를 `AdminProtectedRoute`로 보호
- **역할별 리다이렉트**: 로그인된 사용자가 `/login` 접근 시 역할에 따라 리다이렉트

## 🔐 로그인 플로우

1. **사용자 입력**
   - userId, password 입력

2. **API 호출**
   - `POST /api/auth/login`
   - 백엔드에서 사용자 검증

3. **응답 처리**
   - 성공: 토큰을 쿠키에 저장, **역할에 따라 다른 페이지로 이동**
   - 실패: 에러 메시지 표시

4. **역할별 리다이렉트**
   - **관리자 (ADMIN)**: `/admin` 페이지로 이동
   - **일반 사용자 (USER/ADVISOR)**: `/` 홈페이지로 이동

5. **토큰 관리**
   - Access Token: 쿠키에 저장 (1일 유효)
   - Refresh Token: 쿠키에 저장 (7일 유효)
   - 자동 토큰 갱신 기능
   - 로그아웃 시 쿠키에서 제거

6. **자동 로그인**
   - 페이지 새로고침 시 자동 로그인 체크
   - 토큰 만료 시 자동 갱신 시도
   - 로그인 상태 전역 관리

## 🧪 테스트 계정

### 일반 사용자 (USER)
- `user001` / `password123` - 김철수
- `user002` / `password123` - 이영희

### 전문가 (ADVISOR)
- `advisor001` / `password123` - 한승우 (승인됨)
- `advisor002` / `password123` - 이수진 (승인됨)
- `advisor003` / `password123` - 박미승 (승인안됨)

### 관리자 (ADMIN)
- `admin001` / `password123` - 관리자

## 🔐 역할별 접근 제어

### 관리자 페이지 (`/admin`)
- **접근 가능**: 관리자 (ADMIN) 역할만
- **접근 불가**: 일반 사용자, 전문가, 비로그인 사용자
- **리다이렉트**: 홈페이지 (`/`)로 이동

### 일반 페이지
- **홈페이지**: 모든 사용자 접근 가능
- **로그인 페이지**: 로그인된 사용자는 역할에 따라 리다이렉트

## ⚠️ 에러 처리

- **404**: 존재하지 않는 사용자
- **401**: 잘못된 비밀번호
- **403**: 승인되지 않은 전문가
- **400**: 비활성화된 계정
- **CORS 에러**: 개발 환경에서 Mock fallback으로 처리

## 🔧 환경 설정

- API URL: `http://localhost:8081/api` (포트 수정됨)
- Access Token: 쿠키 (1일 유효)
- Refresh Token: 쿠키 (7일 유효)
- 자동 로그인: 쿠키 기반
- CORS: 백엔드에서 설정 필요 (개발 환경에서 Mock fallback)

## 📝 사용법

1. 백엔드 서버 실행 (포트 8081)
2. 프론트엔드 개발 서버 실행 (`npm run dev`)
3. 로그인 페이지 접속
4. 테스트 계정으로 로그인 시도

### 관리자 테스트
1. `admin001` / `password123`로 로그인
2. 자동으로 `/admin` 페이지로 이동
3. 관리자 전용 기능 확인

### 일반 사용자 테스트
1. `user001` / `password123`로 로그인
2. 홈페이지 (`/`)로 이동
3. `/admin` 접근 시도 → 홈페이지로 리다이렉트

## 🚀 향후 개선사항

- ✅ 토큰 갱신 로직 추가 (완료)
- ✅ 자동 로그인 기능 (완료)
- ✅ 무한 리다이렉트 문제 해결 (완료)
- ✅ 인증 상태 기반 라우팅 (완료)
- ✅ 역할별 리다이렉트 (완료)
- ✅ 관리자 페이지 보호 (완료)
- ✅ CORS 에러 처리 (완료)
- ✅ 모든 Navbar 컴포넌트 통일 (완료)
- 소셜 로그인 연동
- 비밀번호 재설정 기능
- 토큰 만료 알림 기능

## 🔧 최근 수정사항

- **관리자 역할별 리다이렉트**: 관리자 로그인 시 자동으로 `/admin` 페이지로 이동
- **관리자 페이지 보호**: `AdminProtectedRoute` 컴포넌트로 관리자 전용 페이지 보호
- **App.tsx 라우팅 개선**: 로그인된 사용자의 역할에 따른 리다이렉트 로직 추가
- **CORS 에러 처리**: 개발 환경에서 백엔드 연결 실패 시 Mock fallback으로 처리
- **API 포트 수정**: `8080` → `8081`로 변경
- **콘솔 로그 정리**: 불필요한 디버깅 로그 제거
- **모든 Navbar 통일**: `homepage-navbar.tsx`, `new-navbar.tsx`를 AuthContext와 연동 