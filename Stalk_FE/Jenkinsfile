pipeline {
  agent any

  environment {
    BRANCH_NAME = "${env.GIT_BRANCH}".replaceAll(".*/", "")
  }

  stages {
    stage('Deploy FE') {
      steps {
        script {
          def changed = sh(script: "git diff --name-only HEAD~1", returnStdout: true).trim()

          // í•„ìš”í•˜ë‹¤ë©´ FE ë³€ê²½ ì—¬ë¶€ë¡œ ë°°í¬ ìŠ¤í‚µ ê°€ëŠ¥
          // if (!changed.contains("Stalk_FE/")) {
          //   echo "ğŸŸ¡ FE ë””ë ‰í† ë¦¬ ë³€ê²½ ì—†ìŒ â†’ ë°°í¬ ìƒëµ"
          //   return
          // }

          def isProd = BRANCH_NAME == 'master'
          def COMPOSE_FILE = isProd ? 'docker-compose.prod.yml' : 'docker-compose.dev.yml'

          sh """
            echo "ğŸš€ FE docker-compose ì‹¤í–‰ ì¤‘ (${COMPOSE_FILE})..."
            docker compose -f ${COMPOSE_FILE} up -d --build stalk-fe
          """
        }
      }
    }
    
    stage('Deploy nginx') {
      steps {
        script {
          def isProd = BRANCH_NAME == 'master'
          def COMPOSE_FILE = isProd ? 'docker-compose.prod.yml' : 'docker-compose.dev.yml'

          sh """
            echo "ğŸ—‘ï¸ ê¸°ì¡´ nginx ì»¨í…Œì´ë„ˆ ì •ë¦¬ (${COMPOSE_FILE})..."
            docker compose -f ${COMPOSE_FILE} rm -sf nginx || true

            echo "ğŸ›¡ï¸ nginx docker-compose ì‹¤í–‰ ì¤‘ (${COMPOSE_FILE})..."
            docker compose -f ${COMPOSE_FILE} up -d --no-deps nginx
          """
        }
      }
    }
  }
}
