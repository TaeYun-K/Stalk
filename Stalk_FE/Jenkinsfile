pipeline {
  agent any

  environment {
    BRANCH_NAME = "${env.GIT_BRANCH}".replaceAll(".*/", "")
  }

  stages {
    stage('Deploy FE') {
      steps {
        script {
          def changed = sh(script: "git diff --name-only HEAD~1 HEAD", returnStdout: true).trim()

          //í•„ìš”í•˜ë‹¤ë©´ FE ë³€ê²½ ì—¬ë¶€ë¡œ ë°°í¬ ìŠ¤í‚µ ê°€ëŠ¥
          if (!changed.contains("Stalk_FE/")) {
            echo "ğŸŸ¡ FE ë””ë ‰í† ë¦¬ ë³€ê²½ ì—†ìŒ â†’ ë°°í¬ ìƒëµ"
          }

          else {
            def isProd = BRANCH_NAME == 'master'
            def COMPOSE_FILE = isProd ? 'docker-compose.prod.yml' : 'docker-compose.dev.yml'
            def CONTAINER    = isProd ? 'stalk-fe-prod'            : 'stalk-fe-dev'

              // â”€â”€â”€ ì‹œí¬ë¦¿ .env íŒŒì¼ ì£¼ì… â”€â”€â”€
            withCredentials([file(credentialsId: 'frontend-env', variable: 'ENV_FILE')]) {
              dir('Stalk_FE') {
                sh """
                  echo "ğŸ”’ .env íŒŒì¼ ë³µì‚¬ ì¤‘..."
                  rm -f .env
                  cp "$ENV_FILE" .env
                """
              }
            }

            sh"""
                echo "ğŸ—‘ï¸ ê¸°ì¡´ FE ì»¨í…Œì´ë„ˆ ì§ì ‘ ì‚­ì œ (${CONTAINER})..."
                docker rm -f ${CONTAINER} || true

                echo "ğŸš€ FE docker-compose ì‹¤í–‰ ì¤‘ (${COMPOSE_FILE})..."
                docker compose -f ${COMPOSE_FILE} up -d --build stalk-fe
            """
          }
        }
      }
    }
    
    //nginx ì»¨í…Œì´ë„ˆ ìˆ˜ì •ì´ í•„ìš”í•  ë•Œë§Œ ì‚¬ìš©
    stage('Deploy nginx') {
      steps {
        script {
          def isProd = BRANCH_NAME == 'master'
          def COMPOSE_FILE = isProd ? 'docker-compose.prod.yml' : 'docker-compose.dev.yml'

          sh """
            echo "ğŸ—‘ï¸ ê¸°ì¡´ nginx ì»¨í…Œì´ë„ˆ ì •ë¦¬ (${COMPOSE_FILE})..."
            docker compose -f ${COMPOSE_FILE} rm -sf nginx || true

            echo "ğŸ›¡ï¸ nginx docker-compose ì‹¤í–‰ ì¤‘ (${COMPOSE_FILE})..."
            docker compose -f ${COMPOSE_FILE} up -d --no-deps nginx
          """
        }
      }
    }
  }
}
